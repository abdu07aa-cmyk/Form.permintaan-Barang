<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Form Permintaan Barang</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f4f6f8;padding:10px}
input,select,button{padding:6px;margin:4px;width:100%}
button{cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff}
th,td{border:1px solid #ccc;padding:6px;font-size:12px;text-align:center}
th{background:#eee}
.btn{background:#007bff;color:#fff;border:none;border-radius:4px}
.btn-red{background:#dc3545;color:#fff;border:none;border-radius:4px}
.btn-green{background:#28a745;color:#fff;border:none;border-radius:4px}
</style>
</head>

<body>
<h3>ðŸ“¦ Form Permintaan Barang</h3>

<input type="date" id="tanggal">
<input type="text" id="brand" placeholder="Nama Brand">

<h4>Detail Barang</h4>
<table id="inputTable">
<tr>
<th>Line</th>
<th>OP</th>
<th>Jenis</th>
<th>Size</th>
<th>Paper</th>
<th>Permintaan</th>
<th>Kirim</th>
<th>Aksi</th>
</tr>
</table>

<button class="btn" onclick="tambahBaris()">+ Tambah Barang</button>

<br><br>
<button class="btn-green" onclick="simpanData()">ðŸ’¾ Simpan</button>
<button class="btn" onclick="exportExcel()">ðŸ“„ Export Excel</button>
<button class="btn" onclick="kirimWA()">ðŸ“² Kirim WhatsApp</button>

<h4>Data Tersimpan</h4>
<table id="dataTable">
<tr>
<th>Tanggal</th>
<th>Brand</th>
<th>Line</th>
<th>OP</th>
<th>Jenis</th>
<th>Size</th>
<th>Paper</th>
<th>Permintaan</th>
<th>Kirim</th>
<th>Aksi</th>
</tr>
</table>

<script>
// ================= SUPABASE =================
const SUPABASE_URL = "https://gnpjzhwbjeidabxdturx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImducGp6aHdiamVpZGFieGR0dXJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODc4NTUsImV4cCI6MjA4MzM2Mzg1NX0.Lsdt0mC1MCPeUATPukRRnXFwEpsaQdNzs927086vxjY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ================= DATA =================
const inputTable = document.getElementById('inputTable');
const dataTable = document.getElementById('dataTable');

const jenisList=["BOOKLET","FILTER WHITE","FILTER BROWN","DISPLAY","PLAT","MAGNET","DOUBLE TAPE","COVER","PAPER","GRINDER"];
const sizeList=["1 1/4","SINGLE","KS","KSS","KSSS","SKS"];
const paperList=["32 LEAVES","33 LEAVES","35 LEAVES","40 LEAVES","42 LEAVES","50 LEAVES","51 LEAVES","52 LEAVES","60 LEAVES"];
const lineList=["LINE 1","LINE 2","LINE 3","LINE 4","LINE 5","LINE 6","MACHINE"];
const opList=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18];

function opt(list){
 return `<option value="">-- pilih --</option>`+
        list.map(v=>`<option value="${v}">${v}</option>`).join('');
}

// ================= INPUT =================
function tambahBaris(){
 let r = inputTable.insertRow();
 r.innerHTML = `
  <td><select>${opt(lineList)}</select></td>
  <td><select>${opt(opList)}</select></td>
  <td><select>${opt(jenisList)}</select></td>
  <td><select>${opt(sizeList)}</select></td>
  <td><select>${opt(paperList)}</select></td>
  <td><input type="number"></td>
  <td><input type="number"></td>
  <td>
    <button class="btn-red" onclick="this.parentElement.parentElement.remove()">Hapus</button>
  </td>`;
}

// ================= SIMPAN =================
async function simpanData(){
 let tgl = tanggal.value;
 let br = brand.value;
 if(!tgl || !br){ alert('Tanggal & Brand wajib'); return; }

 for(let i=1;i<inputTable.rows.length;i++){
  let c = inputTable.rows[i].cells;
  await sb.from('permintaan_barang').insert({
   tanggal:tgl,
   brand:br,
   line:c[0].children[0].value,
   op:c[1].children[0].value,
   jenis:c[2].children[0].value,
   size:c[3].children[0].value,
   paper:c[4].children[0].value,
   permintaan:c[5].children[0].value,
   kirim:c[6].children[0].value
  });
 }
 inputTable.innerHTML = inputTable.rows[0].outerHTML;
 loadData();
}

// ================= LOAD =================
async function loadData(){
 dataTable.innerHTML = dataTable.rows[0].outerHTML;
 let {data} = await sb.from('permintaan_barang')
  .select('*')
  .order('created_at',{ascending:false});

 data.forEach(d=>{
  let r = dataTable.insertRow();
  r.innerHTML = `
   <td>${d.tanggal}</td>
   <td>${d.brand}</td>
   <td contenteditable>${d.line}</td>
   <td contenteditable>${d.op}</td>
   <td contenteditable>${d.jenis}</td>
   <td contenteditable>${d.size}</td>
   <td contenteditable>${d.paper}</td>
   <td contenteditable>${d.permintaan}</td>
   <td contenteditable>${d.kirim}</td>
   <td>
     <button class="btn" onclick="updateData(${d.id},this)">Update</button>
     <button class="btn-red" onclick="hapusData(${d.id},this)">Hapus</button>
   </td>`;
 });
}

// ================= UPDATE =================
async function updateData(id,btn){
 let c = btn.parentElement.parentElement.cells;
 await sb.from('permintaan_barang').update({
  line:c[2].innerText,
  op:c[3].innerText,
  jenis:c[4].innerText,
  size:c[5].innerText,
  paper:c[6].innerText,
  permintaan:c[7].innerText,
  kirim:c[8].innerText
 }).eq('id',id);
 alert('Data diperbarui');
}

// ================= HAPUS =================
async function hapusData(id,btn){
 if(!confirm('Yakin hapus data ini?')) return;
 await sb.from('permintaan_barang').delete().eq('id',id);
 btn.parentElement.parentElement.remove();
}

// ================= EXCEL =================
function exportExcel(){
 let wb = XLSX.utils.book_new();
 let ws = XLSX.utils.table_to_sheet(dataTable);
 XLSX.utils.book_append_sheet(wb, ws, "Permintaan");
 XLSX.writeFile(wb, "permintaan_barang.xlsx");
}

// ================= WHATSAPP =================
function kirimWA(){
 if(dataTable.rows.length<=1){alert('Data kosong');return;}
 let pesan = 'PERMINTAAN BARANG\n\n';

 for(let i=1;i<dataTable.rows.length;i++){
  let c=dataTable.rows[i].cells;
  pesan +=
   `Tanggal : ${c[0].innerText}\n`+
   `Brand   : ${c[1].innerText}\n`+
   `Line ${c[2].innerText} | OP ${c[3].innerText}\n`+
   `Item : ${c[4].innerText} ${c[5].innerText} ${c[6].innerText}\n`+
   `Qty  : ${c[7].innerText} / ${c[8].innerText}\n\n`;
 }

 let nomor='628XXXXXXXXXX';
 window.open(
  'https://api.whatsapp.com/send?phone='+628979502611+
  '&text='+encodeURIComponent(pesan),
  '_blank'
 );
}

loadData();
</script>
</body>
</html>

 for(let i=1;i<inputTable.rows.length;i++){
  let c = inputTable.rows[i].cells;
  await sb.from('permintaan_barang').insert({
   tanggal:tgl,
   brand:br,
   line:c[0].children[0].value,
   op:c[1].children[0].value,
   jenis:c[2].children[0].value,
   size:c[3].children[0].value,
   paper:c[4].children[0].value,
   permintaan:c[5].children[0].value,
   kirim:c[6].children[0].value
  });
 }
 inputTable.innerHTML = inputTable.rows[0].outerHTML;
 loadData();
}

// ================= LOAD =================
async function loadData(){
 dataTable.innerHTML = dataTable.rows[0].outerHTML;
 let {data} = await sb.from('permintaan_barang')
  .select('*')
  .order('created_at',{ascending:false});

 data.forEach(d=>{
  let r = dataTable.insertRow();
  r.innerHTML = `
   <td>${d.tanggal}</td>
   <td>${d.brand}</td>
   <td contenteditable>${d.line}</td>
   <td contenteditable>${d.op}</td>
   <td contenteditable>${d.jenis}</td>
   <td contenteditable>${d.size}</td>
   <td contenteditable>${d.paper}</td>
   <td contenteditable>${d.permintaan}</td>
   <td contenteditable>${d.kirim}</td>
   <td>
     <button class="btn" onclick="updateData(${d.id},this)">Update</button>
     <button class="btn-red" onclick="hapusData(${d.id},this)">Hapus</button>
   </td>`;
 });
}

// ================= UPDATE =================
async function updateData(id,btn){
 let c = btn.parentElement.parentElement.cells;
 await sb.from('permintaan_barang').update({
  line:c[2].innerText,
  op:c[3].innerText,
  jenis:c[4].innerText,
  size:c[5].innerText,
  paper:c[6].innerText,
  permintaan:c[7].innerText,
  kirim:c[8].innerText
 }).eq('id',id);
 alert('Data diperbarui');
}

// ================= HAPUS =================
async function hapusData(id,btn){
 if(!confirm('Yakin hapus data ini?')) return;
 await sb.from('permintaan_barang').delete().eq('id',id);
 btn.parentElement.parentElement.remove();
}

// ================= EXCEL =================
function exportExcel(){
 let wb = XLSX.utils.book_new();
 let ws = XLSX.utils.table_to_sheet(dataTable);
 XLSX.utils.book_append_sheet(wb, ws, "Permintaan");
 XLSX.writeFile(wb, "permintaan_barang.xlsx");
}

// ================= WHATSAPP =================
function kirimWA(){
 if(dataTable.rows.length<=1){alert('Data kosong');return;}
 let pesan = 'PERMINTAAN BARANG\n\n';

 for(let i=1;i<dataTable.rows.length;i++){
  let c=dataTable.rows[i].cells;
  pesan +=
   `Tanggal : ${c[0].innerText}\n`+
   `Brand   : ${c[1].innerText}\n`+
   `Line ${c[2].innerText} | OP ${c[3].innerText}\n`+
   `Item : ${c[4].innerText} ${c[5].innerText} ${c[6].innerText}\n`+
   `Qty  : ${c[7].innerText} / ${c[8].innerText}\n\n`;
 }

 let nomor='628XXXXXXXXXX';
 window.open(
  'https://api.whatsapp.com/send?phone='+628979502611+
  '&text='+encodeURIComponent(pesan),
  '_blank'
 );
}

loadData();
</script>
</body>
</html>
